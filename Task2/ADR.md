### **Название задачи:** Выбор основного message broker
### **Автор:** Архитектор
### **Дата:** 11.09.2024

### <a name="_u8xz25hbrgql"></a>**Нефункциональные требования**
Система должна:
обеспечивать достаточно высокую отказоустойчивость 99,95%;
быть расширяемой, то есть иметь возможность разработать новый функционал без изменений существующего;
иметь высокую производительность — от момента возникновения нештатной ситуации, зафиксированной с помощью видеоаналитики, должно проходить не более 5 секунд до момента оповещения;
позволять системе видеоаналитики реагировать в реальном времени (миллисекунды).

### **Решение 1**
Архитектура на основе RabbitMQ для обеспечения низкой задержки и поддержки MQTT.

**Преимущества:**
- **Поддержка MQTT**: Нативная интеграция с IoT датчиками
- **Низкая задержка**: <5ms для доставки сообщений
- **Гибкость протоколов**: AMQP, MQTT, STOMP, HTTP
- **Простота управления**: Широкий инструментарий мониторинга
- **Кластеризация**: Mirroring queues для отказоустойчивости

### **Компромиссы и риски**
| **Риск** | **Митогирующие меры** |
|----------|---------------------|
| **Производительность при высокой нагрузке** | Мониторинг и автоматическое масштабирование |
| **Потеря сообщений при сбоях** | Подтверждение доставки (acknowledgement) |
| **Сложность управления состоянием** | Использование HA кластера с зеркалированием |
| **Ограничение по количеству соединений** | Connection pooling и оптимизация |

### **Интеграции**
- **Дачтики → RabbitMQ**: MQTT для эффективной работы с IoT
- **Сервисы → RabbitMQ**: AMQP для надежной доставки
- **AI Gateway → Analytics**: gRPC для низкой задержки

### **Решение 2**
Архитектура на основе Apache Kafka для обработки высоких нагрузок.

**Преимущества:**
- **Высокая пропускная способность**: Миллионы сообщений в секунду
- **Горизонтальное масштабирование**: Легкое добавление нод
- **Надежное хранение**: Сообщения хранятся заданное время
- **Exactly-once семантика**: Гарантированная доставка
- **Экосистема**: Kafka Connect, Kafka Streams, KSQL

### **Компромиссы и риски**
| **Риск** | **Митогирующие меры** |
|----------|---------------------|
| **Высокая сложность** | Выделенная команда для управления Kafka |
| **Задержка при малых нагрузках** | Оптимизация конфигурации |
| **Ресурсоемкость** | Мониторинг и планирование ресурсов |
| **Сложность MQTT интеграции** | Использование MQTT proxy |

### **Интеграции**
- **Все сервисы → Kafka**: Единый протокол для всех данных
- **Kafka Streams**: Реaltime обработка внутри кластера
- **ClickHouse**: Для аналитических запросов

